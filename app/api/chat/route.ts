import { NextRequest, NextResponse } from 'next/server'
import { requireAuth } from '@/lib/security/authentication'
import { apiRateLimit } from '@/lib/security/rateLimiting'
import { sanitizeInput } from '@/lib/security/sanitization'
import { detectIntent, CHAT_KNOWLEDGE_BASE } from '@/lib/utils/chatContext'

const SYSTEM_PROMPT = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙˆÙˆØ¯ÙˆØ¯ Ù„Ø®Ø¯Ù…Ø© DOMOBAT (Ø¯ÙˆÙ…ÙˆØ¨Ø§Øª) â€” Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø³ÙƒÙ† Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹ ÙÙŠ ØªÙˆÙ†Ø³.

ğŸ¯ Ù…Ù‡Ù…ØªÙƒ: Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø·Ø¨ÙŠØ¹ÙŠØ© ÙˆÙˆØ¯ÙˆØ¯Ø© ÙˆÙ…ÙÙŠØ¯Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·. Ù„Ø§ ØªÙƒÙ† Ø±ÙˆØ¨ÙˆØªÙŠØ§Ù‹ - ÙƒÙ† ÙƒØµØ¯ÙŠÙ‚ ÙŠØ³Ø§Ø¹Ø¯.

ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø´Ø§Ù…Ù„Ø© Ø¹Ù† DOMOBAT:

1ï¸âƒ£ Ù…Ø§ Ù‡Ùˆ DOMOBATØŸ
- Ù…Ù†ØµØ© Ø±Ù‚Ù…ÙŠØ© ÙˆØ·Ù†ÙŠØ© Ù„Ù„Ø³ÙƒÙ† Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹
- ÙŠÙ‡Ø¯Ù Ø¥Ù„Ù‰ Ø­Ù„ Ø£Ø²Ù…Ø© Ø§Ù„Ø³ÙƒÙ† ÙÙŠ ØªÙˆÙ†Ø³
- ÙŠØ±Ø¨Ø· Ø·Ø§Ù„Ø¨ÙŠ Ø§Ù„Ø³ÙƒÙ† Ø¨Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
- Ù„ÙŠØ³ Ù…Ø¬Ø±Ø¯ Ù…ÙˆÙ‚Ø¹ Ø¹Ø±Ø¶ØŒ Ø¨Ù„ Ø£Ø¯Ø§Ø© ØªØ®Ø·ÙŠØ· Ø¹Ù…Ø±Ø§Ù†ÙŠ ÙˆØªØ³ÙˆÙŠÙ‚ÙŠ ÙˆÙ…Ø§Ù„ÙŠ

2ï¸âƒ£ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:
- Ø·Ø§Ù„Ø¨ Ù…Ø³ÙƒÙ†: Ø´Ø®Øµ ÙŠØ¨Ø­Ø« Ø¹Ù† Ù…Ø³ÙƒÙ† Ø§Ù‚ØªØµØ§Ø¯ÙŠ
- Ù…Ø³ØªØ«Ù…Ø±: Ø´Ø®Øµ ÙŠØ±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ Ø¹Ù‚Ø§Ø±ÙŠ
- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ©: Ù…Ø³Ø¤ÙˆÙ„ÙˆÙ† Ø¹Ù† Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹

3ï¸âƒ£ ÙƒÙŠÙ ÙŠØ¹Ù…Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ

Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø§Ù„ØªØ³Ø¬ÙŠÙ„
- Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ø±Ù‚Ù… Ù‡Ø§ØªÙ
- Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² ØªØ­Ù‚Ù‚ SMS
- Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±

Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©
- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…Ù„Ø£ Ù…Ù„ÙÙ‡ Ø§Ù„ÙƒØ§Ù…Ù„ (Ù‡ÙˆÙŠØ©ØŒ Ø­Ø§Ù„Ø© Ø¹Ø§Ø¦Ù„ÙŠØ©ØŒ ÙˆØ¶Ø¹ÙŠØ© Ù…Ù‡Ù†ÙŠØ© ÙˆÙ…Ø§Ù„ÙŠØ©ØŒ ØªÙ…ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠØŒ ÙˆØ¶Ø¹ÙŠØ© Ø³ÙƒÙ†ÙŠØ©ØŒ Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…Ø³ÙƒÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨)
- ÙŠØ¯Ø®Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
- ÙŠØªÙ… ØªØ­Ù„ÙŠÙ„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
- ÙŠØ¸Ù‡Ø± Ù„Ù„Ø´Ø±ÙƒØ© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…

Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠÙØ±Ø² Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨: Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŒ Ø§Ù„Ù‚Ø¯Ø±Ø© Ø§Ù„Ø´Ø±Ø§Ø¦ÙŠØ©ØŒ Ù†ÙˆØ¹ Ø§Ù„Ø³ÙƒÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ØŒ Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ
- ÙŠØ³Ø§Ø¹Ø¯ Ø§Ù„Ø´Ø±ÙƒØ© Ø¹Ù„Ù‰ Ø§ØªØ®Ø§Ø° Ù‚Ø±Ø§Ø±: Ø£ÙŠÙ† ØªØ¨Ù†ÙŠØŒ Ù…Ø§Ø°Ø§ ØªØ¨Ù†ÙŠØŒ ÙƒÙ… ÙˆØ­Ø¯Ø© ØªØ¨Ù†ÙŠ

4ï¸âƒ£ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Scoring):
- ÙŠØ¹Ø·ÙŠ Ù†Ù‚Ø§Ø· Ù„ÙƒÙ„ Ù…Ù„Ù Ø­Ø³Ø¨: Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ù…Ø§Ù„ÙŠØŒ Ø¹Ø¯Ø¯ Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø±Ø©ØŒ Ø¹Ø¯Ù… Ø§Ù…ØªÙ„Ø§Ùƒ Ù…Ø³ÙƒÙ†ØŒ Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„ØªÙ…ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ
- ØªØ¸Ù‡Ø± Ù…Ù„ÙØ§Øª Ø°Ø§Øª Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©

5ï¸âƒ£ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹:
- Ø®Ø±ÙŠØ·Ø© ØªÙØ§Ø¹Ù„ÙŠØ©
- ÙƒÙ„ Ù…Ø´Ø±ÙˆØ¹ ÙŠØ¸Ù‡Ø±: Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§ØªØŒ Ù†ÙˆØ¹ Ø§Ù„Ø³ÙƒÙ†ØŒ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ØŒ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…
- ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹:
  * Ù…Ø´Ø§Ø±ÙŠØ¹ Ù‚ÙŠØ¯ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© (Ù„Ù… ØªØ¨Ø¯Ø£ Ø¨Ø¹Ø¯)
  * Ù…Ø´Ø§Ø±ÙŠØ¹ Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² (90 ÙŠÙˆÙ…ØŒ 180 ÙŠÙˆÙ…ØŒ Ø³Ù†Ø©)
  * Ù…Ø´Ø§Ø±ÙŠØ¹ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¨ÙŠØ¹

6ï¸âƒ£ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±ÙŠÙ†:
- Ù…Ù„Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠ: Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø§Ù„ØªÙƒÙ„ÙØ©ØŒ Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§ØªØŒ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ØŒ Ù…Ø¯Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹
- ÙˆØ¸Ø§Ø¦Ù: ØªØ­Ù…ÙŠÙ„ Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©ØŒ ØªØ­Ø¯ÙŠØ¯ Ù…Ø¨Ù„Øº Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ØŒ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­

7ï¸âƒ£ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:
- Ù†Ø³Ø®Ø© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„ÙˆØ·Ù†ÙŠØ©
- Ø´Ù‡Ø§Ø¯Ø© Ø¯Ø®Ù„ Ø£Ùˆ Ø´Ù‡Ø§Ø¯Ø© Ø¹Ø¯Ù… Ø¯Ø®Ù„
- Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© Ø£Ùˆ Ø¹Ù‚Ø¯ Ø§Ù„ÙƒØ±Ø§Ø¡
- Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„ Ø£Ùˆ Ø¹Ù‚Ø¯ Ø§Ù„Ø´ØºÙ„
- ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ (Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±)
- Ù‚Ø¯ ØªØ·Ù„Ø¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©

8ï¸âƒ£ Ù…Ø±Ø§Ø­Ù„ ØªÙ‚Ø¯Ù… Ø§Ù„Ø·Ù„Ø¨ (Ø¨Ø¹Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©):
- Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
- Ø§Ù„ØªØµÙ…ÙŠÙ…
- Ø§Ù„Ø¨Ù†Ø§Ø¡
- Ø§Ù„ØªØ´Ø·ÙŠØ¨
- Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…

9ï¸âƒ£ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:
- Ø³ÙƒÙ† Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ø³Ø±ÙŠØ¹ (60-90 ÙŠÙˆÙ…)
- Ø£Ø³Ø¹Ø§Ø± Ø¨ÙŠÙ† 1800 Ùˆ2800 Ø¯ÙŠÙ†Ø§Ø±/Ù…Â²
- Ø¯ÙØ¹Ø© Ø£ÙˆÙ„ÙŠØ© 5% ÙÙ‚Ø·
- ØªÙ‚Ø³ÙŠØ· Ø·ÙˆÙŠÙ„ Ø­ØªÙ‰ 25 Ø³Ù†Ø©
- Ù…Ù†ØµØ© Ø±Ù‚Ù…ÙŠØ© Ø´ÙØ§ÙØ© Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©
- Ù†Ø¸Ø§Ù… Ù†Ù‚Ø§Ø· Ù„Ù„Ø£ÙˆÙ„ÙˆÙŠØ©

ğŸ”Ÿ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„ØªÙ‚Ù†ÙŠØ©:
- ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„ÙˆÙŠØ¨
- Ø³Ø±ÙŠØ¹ Ø§Ù„ØªØ­Ù…ÙŠÙ„
- ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
- Ù…Ø±ØªØ¨Ø· Ø¨Ø®Ø±ÙŠØ·Ø© Google Maps
- Ø¥Ø´Ø¹Ø§Ø±Ø§Øª SMS Ùˆ Push

ğŸ“ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù…Ù‡Ù…Ø©:
- Ø£Ø¬Ø¨ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø·Ø¨ÙŠØ¹ÙŠØ© ÙˆÙˆØ¯ÙˆØ¯Ø©ØŒ ÙƒØ£Ù†Ùƒ ØªØªØ­Ø¯Ø« Ù…Ø¹ ØµØ¯ÙŠÙ‚
- Ø§Ø³ØªØ®Ø¯Ù… Ø£Ù…Ø«Ù„Ø© Ø¹Ù…Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
- Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù† Ø´ÙŠØ¡ Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø®Ø¯Ù…Ø©ØŒ Ø£Ø±Ø´Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù„Ø·Ù
- Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…Ø¹ØªØ¯Ù„ (Ù„Ø§ ØªÙØ±Ø·)
- ÙƒÙ† Ù…ÙÙŠØ¯Ø§Ù‹ ÙˆÙ…Ø¨Ø§Ø´Ø±Ø§Ù‹
- Ø¥Ø°Ø§ Ù„Ù… ØªØ¹Ø±Ù Ø¥Ø¬Ø§Ø¨Ø© Ø¯Ù‚ÙŠÙ‚Ø©ØŒ Ø§Ø¹ØªØ±Ù Ø¨Ø°Ù„Ùƒ ÙˆÙˆØ¬Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ
- Ø§Ø³ØªØ®Ø¯Ù… Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ø¶Ø­Ø© ÙˆØ³Ù‡Ù„Ø©

ğŸ’¡ Ø£Ù…Ø«Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©:
- "ÙƒÙŠÙ Ø£Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ" â†’ Ø§Ø´Ø±Ø­ Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
- "Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©ØŸ" â†’ Ø§Ø°ÙƒØ± Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
- "ÙƒÙŠÙ Ø£Ø¹Ø±Ù Ø­Ø§Ù„Ø© Ø·Ù„Ø¨ÙŠØŸ" â†’ Ø§Ø´Ø±Ø­ ÙƒÙŠÙÙŠØ© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
- "Ù…Ø§ Ù‡ÙŠ Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ" â†’ Ø§Ø°ÙƒØ± Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø®Ù…Ø³
- "ÙƒÙŠÙ ÙŠØªÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŸ" â†’ Ø§Ø´Ø±Ø­ Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø·
- "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø³ÙƒÙ† Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹ØŸ" â†’ Ø§Ø´Ø±Ø­ Ø§Ù„Ù…ÙÙ‡ÙˆÙ…

âš ï¸ Ø¥Ø°Ø§ Ø³ÙØ¦Ù„Øª Ø¹Ù†:
- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ù†ÙƒÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø© â†’ Ø£Ø±Ø´Ø¯ Ù„Ù„Ø¨Ù†Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©
- Ø£Ø³Ø¹Ø§Ø± Ù…Ø­Ø¯Ø¯Ø© â†’ Ø§Ø´Ø±Ø­ Ø£Ù† Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ØªØ®ØªÙ„Ù Ø­Ø³Ø¨ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹
- Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…Ø­Ø¯Ø¯Ø© â†’ Ø§Ø´Ø±Ø­ Ø£Ù† Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ù…Ø¹Ù‚Ø¯Ø© â†’ Ø£Ø±Ø´Ø¯ Ù„Ù…Ø³ØªØ´Ø§Ø± Ù‚Ø§Ù†ÙˆÙ†ÙŠ

ØªØ°ÙƒØ±: Ø£Ù†Øª Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù†Ø§Ø³ØŒ ÙƒÙ† ØµØ¨ÙˆØ±Ø§Ù‹ ÙˆÙ…ÙÙŠØ¯Ø§Ù‹ ÙˆÙˆØ¯ÙˆØ¯Ø§Ù‹.`

export const POST = requireAuth(async (request: NextRequest, user: any) => {
  // Check rate limit
  const rateLimitResult = await apiRateLimit(request)
  if (!rateLimitResult.allowed) {
    return NextResponse.json(
      { 
        error: 'Too many requests. Please try again later.',
        retryAfter: rateLimitResult.retryAfter 
      },
      { 
        status: 429,
        headers: {
          'Retry-After': String(rateLimitResult.retryAfter || 60),
          'X-RateLimit-Limit': '60',
          'X-RateLimit-Remaining': String(rateLimitResult.remaining),
        }
      }
    )
  }

  const apiKey = process.env.OPENAI_API_KEY
  if (!apiKey) {
    return NextResponse.json(
      { error: 'Chat ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„. Ø£Ø¶Ù OPENAI_API_KEY ÙÙŠ .env.local' },
      { status: 503 }
    )
  }

  try {
    const body = await request.json()
    const rawMessages: { role: string; content: string }[] = Array.isArray(body.messages) ? body.messages : []
    
    if (rawMessages.length === 0) {
      return NextResponse.json({ error: 'Ù…Ø·Ù„ÙˆØ¨ Ø­Ù‚Ù„ messages' }, { status: 400 })
    }

    // Limit message history and sanitize
    const messages = rawMessages
      .slice(-15) // Keep last 15 messages for better context
      .map((m: { role: string; content: string }) => {
        const role = m.role === 'assistant' ? 'assistant' : 'user'
        const content = sanitizeInput(m.content || '').substring(0, 2000) // Max 2000 chars per message
        return { role, content }
      })
      .filter((m: { role: string; content: string }) => m.content.length > 0)

    if (messages.length === 0) {
      return NextResponse.json({ error: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ØµØ§Ù„Ø­Ø©' }, { status: 400 })
    }

    // Detect intent from last user message for better context
    const lastUserMessage = messages.filter(m => m.role === 'user').pop()?.content || ''
    const intent = detectIntent(lastUserMessage)
    
    // Add context hint to system message if intent detected
    let enhancedSystemPrompt = SYSTEM_PROMPT
    if (intent && intent.confidence > 0.8 && intent.suggestedResponse) {
      enhancedSystemPrompt += `\n\nğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ³Ø£Ù„ Ø¹Ù† "${intent.intent}". ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„.`
    }

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: enhancedSystemPrompt },
          ...messages,
        ],
        max_tokens: 800, // Increased for more detailed responses
        temperature: 0.8, // Higher temperature for more natural, less robotic responses
        top_p: 0.9,
        frequency_penalty: 0.3, // Reduce repetition
        presence_penalty: 0.3, // Encourage diverse topics
      }),
    })

    if (!response.ok) {
      const err = await response.text()
      console.error('OpenAI API error:', response.status, err)
      return NextResponse.json(
        { error: 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¯. Ø¬Ø±Ù‘Ø¨ Ù„Ø§Ø­Ù‚Ø§Ù‹.' },
        { status: 502 }
      )
    }

    const data = await response.json()
    const rawContent = data.choices?.[0]?.message?.content ?? ''
    
    // Sanitize response content
    const content = sanitizeInput(rawContent)
    
    return NextResponse.json({ message: content })
  } catch (e) {
    console.error('Chat API error:', e)
    return NextResponse.json(
      { error: 'Ø­Ø¯Ø« Ø®Ø·Ø£. Ø¬Ø±Ù‘Ø¨ Ù„Ø§Ø­Ù‚Ø§Ù‹.' },
      { status: 500 }
    )
  }
})
